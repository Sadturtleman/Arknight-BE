name: Deploy to GCP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/${{ secrets.GCP_USERNAME }}/Arknight-BE
            
            # 1. 코드 업데이트
            git pull origin main
            
            # 2. uv를 이용한 환경 동기화 (uv가 설치된 경로 확인 필요)
            export PATH="$HOME/.local/bin:$PATH"
            uv sync --no-dev
            
            # 3. 서버 재시작
            sudo systemctl restart arknight